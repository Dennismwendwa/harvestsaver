{% extends "accounts/layout.html" %}
{% load static %}
{% load humanize %}

{% block title %}
HarvestSaver â€“ Checkout
{% endblock %}

{%block javascript%}
<script src="{% static 'assets/js/checkout.js' %}"></script>
{%endblock%}

{% block category %}
<section class="py-4 mt-2">
    <div class="container">
        <form action="{% url 'farm:checkout' %}" method="post">
            {% csrf_token %}

            <div class="row g-4">

                <!-- LEFT: CHECKOUT FORM -->
                <div class="col-md-8">

                    <!-- Shipping Address -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="mb-3">1. Shipping Address</h4>

                            <div class="mb-3">
                                <label class="form-label">Delivery Address</label>
                                <textarea
                                    name="address"
                                    class="form-control"
                                    rows="4"
                                    placeholder="Enter full shipping address (landmarks, phone contact, notes...)"
                                    required
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="mb-3">2. Payment Method</h4>

                            <div class="mb-3">
                                <select id="paymentMethod" name="payment_method" class="form-select" required>
                                    <option value="" disabled selected>Select Payment Method</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="pay_on_delivery">Pay on Delivery</option>
                                </select>
                            </div>

                            <!-- M-Pesa Form -->
                            <div id="mpesaForm" class="d-none mt-3">
                                <label class="form-label">M-Pesa Phone Number</label>
                                <input
                                    type="text"
                                    name="mpesa_number"
                                    class="form-control"
                                    placeholder="e.g. 07XXXXXXXX"
                                >
                            </div>

                            <!-- Bank Transfer Form -->
                            <div id="bankForm" class="d-none mt-3">
                                <label class="form-label">Bank Name</label>
                                <input
                                    type="text"
                                    name="bank_name"
                                    class="form-control"
                                    placeholder="Enter your bank name"
                                >
                                <label class="form-label mt-2">Account Number</label>
                                <input
                                    type="text"
                                    name="account_number"
                                    class="form-control"
                                    placeholder="Enter your account number"
                                >
                            </div>

                        </div>
                    </div>
                    <!-- Transport -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="mb-3">
                                3. Transport & Route
                                <span class="badge bg-danger">Farm Transit</span>
                            </h4>

                            <!-- ROUTE -->
                            <div class="row g-3 mb-1">
                                {%comment%}
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-primary">
                                        Pickup From (Farm Location)
                                    </label>
                                    <input
                                        type="text"
                                        name="pickup_location"
                                        class="form-control form-control-lg"
                                        value="{{ farm_location }}"
                                        required
                                    >
                                </div>
                                {%endcomment%}

                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-success">
                                        Deliver To (Destination)
                                    </label>
                                    <input
                                        type="text"
                                        name="delivery_destination"
                                        class="form-control form-control-lg"
                                        required
                                    >
                                </div>
                            </div>

                            {# ================= MIXED CART ================= #}
                            {% if delivery_type == "mixed" %}
                            {# ================= MIXED CART ================= #}
                            {% if delivery_type == "mixed" %}
                                <div class="alert alert-warning">
                                    <strong>Delivery optimized for freshness</strong><br>
                                    Fresh items will ship Express. You may upgrade the rest.
                                </div>

                                <ul class="list-group mb-3">
                                    <!-- PERISHABLES (FORCED EXPRESS) -->
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>Perishable items</strong>
                                            <div class="text-muted small">Requires Express delivery</div>
                                        </div>
                                        <div class="text-success fw-bold">
                                            ðŸšš Arrives Tomorrow
                                        </div>
                                    </li>

                                    <!-- NON-PERISHABLES (USER CHOICE) -->
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>Non-perishable items</strong>
                                                <div class="text-muted small">
                                                    Default: Standard delivery (2â€“3 days)
                                                </div>
                                            </div>
                                            <div class="text-muted">
                                                ðŸšš 2â€“3 days
                                            </div>
                                        </div>

                                        <!-- UPGRADE OPTION -->
                                        <div class="form-check mt-2">
                                            <input
                                                class="form-check-input"
                                                type="checkbox"
                                                name="upgrade_non_perishable_express"
                                                id="upgradeExpress"
                                                value="true"
                                            >
                                            <label class="form-check-label fw-bold text-success" for="upgradeExpress">
                                                Upgrade non-perishables to Express
                                                <span class="badge bg-success ms-1">Faster</span>
                                            </label>
                                            <div class="small text-muted">
                                                ðŸšš Arrives Tomorrow Â· Extra cost applies
                                            </div>
                                        </div>
                                    </li>
                                </ul>

                                <!-- SYSTEM DECIDES BASE TRANSPORT -->
                                <input type="hidden" name="transport_option" value="Mixed">
                            {% endif %}

                            {# ================= PERISHABLE ONLY ================= #}
                            {% elif delivery_type == "perishable" %}
                                <div class="form-check border border-success bg-light p-3 rounded mb-4">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        checked
                                        disabled
                                    >
                                    <label class="form-check-label fw-bold text-success">
                                        Express Delivery (Required)
                                        <span class="badge bg-success ms-2">Freshness Guaranteed</span>
                                    </label>
                                    <small class="d-block text-muted">
                                        Perishable items must ship via Express.
                                    </small>
                                    <div class="text-success fw-bold mt-1">
                                        ðŸšš Arrives Tomorrow
                                    </div>
                                </div>

                                <input type="hidden" name="transport_option" value="Express">

                            {# ================= NON-PERISHABLE ONLY ================= #}
                            {% else %}
                                <div class="row mb-4">
                                    <!-- EXPRESS -->
                                    <div class="col-md-6">
                                        <div class="form-check border border-success bg-light p-3 rounded">
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="transport_option"
                                                id="express"
                                                value="Express"
                                                checked
                                            >
                                            <label class="form-check-label fw-bold text-success" for="express">
                                                Express Delivery
                                                <span class="badge bg-success ms-2">Recommended</span>
                                            </label>
                                            <small class="d-block text-muted">
                                                Fast, direct from farm to you.
                                            </small>
                                            <div class="text-success fw-bold mt-1">
                                                ðŸšš Arrives Tomorrow
                                            </div>
                                        </div>
                                    </div>

                                    <!-- STANDARD -->
                                    <div class="col-md-6">
                                        <div class="form-check border p-3 rounded">
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="transport_option"
                                                id="standard"
                                                value="Standard"
                                            >
                                            <label class="form-check-label fw-bold" for="standard">
                                                Standard Delivery
                                            </label>
                                            <small class="d-block text-muted">
                                                Consolidated (2â€“3 days).
                                            </small>
                                            <div class="text-muted mt-1">
                                                ðŸšš Arrives in 2â€“3 days
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- SHIPPING COST -->
                            <div class="alert alert-info mt-3">
                                Shipping Cost:
                                <strong>Ksh {{ shipping|floatformat:2 }}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="text-center">
                        <button class="btn btn-success btn-lg px-5" type="submit">
                            Checkout
                        </button>
                    </div>
                </div>

                <!-- RIGHT: ORDER SUMMARY -->
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body">

                            <h4 class="text-center mb-3">Order Summary</h4>

                            <div class="d-flex justify-content-between">
                                <span>Items</span>
                                <strong>Ksh {{ total|floatformat:2|intcomma }}</strong>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span>Shipping (3%)</span>
                                <strong>Ksh {{ shipping|floatformat:2|intcomma }}</strong>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between">
                                <span class="fw-bold text-danger">Total</span>
                                <span class="fw-bold text-danger">
                                    Ksh {{ total_cost|floatformat:2|intcomma }}
                                </span>
                            </div>

                            <hr>

                            <div class="alert alert-info text-center mb-0">
                                Track your goods easily using <strong>Farm Transit</strong>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>
</section>
{% endblock %}
