{% extends "accounts/layout.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Farmer Dashboard
{% endblock %}

{% block category %}
<section>
<div class="container mt-4">
    <h4 class="border-bottom mb-3">Farmer Dashboard</h4>

    <!-- FLASH MESSAGES -->
    <div class="p-2">
        {% for message in messages %}
        <p class="alert alert-{{message.tags}}">{{message}}</p>
        {% endfor %}
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs" id="farmerTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">Overview</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#farm">My Farm</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#products">Products</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orders">Orders</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#inventory">Inventory</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#weather">Weather</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments">Payments</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#messages">Messages</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports">Reports</button>
        </li>
    </ul>

    <!-- TAB CONTENT -->
    <div class="tab-content mt-4">

        <!-- OVERVIEW -->
        <div class="tab-pane fade show active" id="overview">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Products</h6>
                        <h4>{{ total_products }}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Orders</h6>
                        <h4>{{ total_orders }}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Sales</h6>
                        <h4>KES {{ total_sales_per_farmer }}</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- FARM PROFILE TAB -->
        <div class="tab-pane fade" id="farm">
            <h5>Your Farms</h5>

            {% if farms %}
                <div class="d-flex">
                {% for farm in farms %}
                    <div class="card mb-3 me-1 p-2 {%if not farm.is_verified %}bg-warning{%endif%}">
                        <div class="card-body">
                            <h6>{{ farm.name }}</h6>
                            <p><strong>Owner:</strong> {{ farm.owner.get_full_name }}</p>
                            <p><strong>Latitude:</strong> {{ farm.latitude }}</p>
                            <p><strong>Longitude:</strong> {{ farm.longitude }}</p>
                            <p><strong>Address:</strong> {{ farm.address }}</p>
                            <p><strong>Hub:</strong> {{ farm.hub.name|default:"Not assigned" }}</p>
                            <p><strong>Verified:</strong> {%if farm.is_verified %}Yes{%else%}No{%endif%}</p>
                            <p><strong>Created At:</strong> {{ farm.created_at|date:"M d, Y" }}</p>

                            <button class="btn btn-sm btn-primary" onclick="showForm({{ farm.id }})">Edit</button>

                            <!-- Hidden edit form -->
                            <div id="farm-form-{{ farm.id }}" style="display:none; margin-top: 10px;">
                                <form action="{% url 'farm:farmer_dashboard' %}" method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="farm_id" value="{{ farm.id }}">
                                    {% if edit_form and edit_form.instance.id == farm.id %}
                                        {{ edit_form|crispy }}
                                    {% endif %}
                                    <button type="submit" class="btn btn-success btn-sm">Save</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p>No farms available.</p>
            {% endif %}

            <h5 class="mt-4">Create New Farm</h5>
            <div class="card p-3 col-md-6">
                <form action="{% url 'farm:create_or_edit_farm' %}" method="post" enctype="multipart/form-data" id="new-farm-form">
                    {% csrf_token %}
                    {{ new_farm_form.name|as_crispy_field }}
                    {{ new_farm_form.address|as_crispy_field }}

                    <!-- Hidden latitude/longitude -->
                    <input type="hidden" name="latitude" id="id_latitude" required>
                    <input type="hidden" name="longitude" id="id_longitude" required>

                    <label class="mt-3 fw-bold">Pick Farm Location</label>
                    <div id="farm-map" style="height: 400px;"></div>

                    <button type="submit" class="btn btn-primary mt-3">Add Farm</button>
                </form>
            </div>
        </div>


        <!-- PRODUCTS -->
<!-- PRODUCTS -->
<div class="tab-pane fade" id="products">

    <div class="row">
        {% for product in current_farmer_products %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm h-100">

                <img 
                    src="{{ product.image.url }}" 
                    class="card-img-top" 
                    style="height: 180px; object-fit: cover;"
                    alt="{{ product.name }}"
                >

                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>

                    <p class="mb-1">
                        <strong>Category:</strong> {{ product.category.name }}
                    </p>

                    <p class="mb-1 accompanied by a smaller font">
                        <strong>Farm:</strong> {{ product.farm.name }}
                    </p>

                    <p class="mb-1">
                        <strong>Price:</strong> KES {{ product.price }}
                    </p>

                    <p class="mb-1">
                        <strong>Stock:</strong> {{ product.quantity }}
                        {% if product.unit_quantity_type %}
                            {{ product.unit_quantity_type }}
                        {% endif %}
                    </p>

                    <p class="mb-1">
                        <strong>Harvest:</strong> {{ product.harvest_date|date:"M d, Y" }}
                    </p>

                    <p>
                        <strong>Status:</strong>
                        {% if product.is_available %}
                            <span class="badge bg-success">Available</span>
                        {% else %}
                            <span class="badge bg-secondary">Unavailable</span>
                        {% endif %}
                    </p>
                </div>

                <div class="card-footer d-flex justify-content-between">
                    <a href="" 
                       class="btn btn-sm btn-outline-primary">
                        Edit
                    </a>

                    {% if product.is_available %}
                    <a href="" 
                       class="btn btn-sm btn-outline-danger">
                        Disable
                    </a>
                    {% else %}
                    <a href="{% url 'farm:toggle_product' product.id %}" 
                       class="btn btn-sm btn-outline-success">
                        Enable
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
            <p class="text-muted">No products yet.</p>
        {% endfor %}
    </div>

    <hr>

    <!-- ADD PRODUCT FORM -->
    <div class="row mt-4">
        <div class="col-md-6">
            <h5>Add New Product</h5>
            <div class="card p-3 shadow-sm">
                <form action="{% url 'farm:create_product' %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ products_form|crispy }}
                    <button class="btn btn-primary w-100 mt-3" type="submit">
                        Add Product
                    </button>
                </form>
            </div>
        </div>
    </div>

</div>


        <!-- ORDERS -->
        <div class="tab-pane fade" id="orders">
            {% for item in order_items %}
                <div class="card p-2 mb-2">
                    <div>
                        <strong>Order #{{ item.order.id }}</strong>
                        ({{ item.order.status }})
                    </div>

                    <div>
                        Buyer: {{ item.order.customer.username }}
                    </div>

                    <div>
                        Product: {{ item.product.name }}
                    </div>

                    <div>
                        Quantity: {{ item.quantity }}
                    </div>

                    <div>
                        Subtotal: 
                        {{ item.quantity|floatformat:2 }} × {{ item.product.price }} =
                        <strong>KES {{ item.subtotal }}</strong>
                    </div>
                </div>
            {% empty %}
                <p>No orders for your products yet.</p>
            {% endfor %}
        </div>


        <!-- INVENTORY -->
        <div class="tab-pane fade" id="inventory">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Farm</th>
                            <th>Available Qty</th>
                            <th>Unit</th>
                            <th>Unit Size</th>
                            <th>Price (KES)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventory %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>{{ item.farm.name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.unit_quantity_type }}</td>
                            <td>{{ item.unit_quantity|default:"-" }}</td>
                            <td>{{ item.price }}</td>
                            <td>
                                {% if item.quantity == 0 %}
                                    <span class="badge bg-danger">Out of stock</span>
                                {% elif item.quantity < 10 %}
                                    <span class="badge bg-warning">Low</span>
                                {% else %}
                                    <span class="badge bg-success">In stock</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No inventory available.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>


        <!-- WEATHER -->
        <div class="tab-pane fade" id="weather">
            <h5 class="mb-3">Next 24 Hours Forecast</h5>

            <div class="row">
                {% for w in weather_data_list %}
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card text-center shadow-sm p-3">

                        <small class="text-muted">
                            {{ w.dt_readable|date:"D, H:i" }}
                        </small>

                        <img 
                            src="https://openweathermap.org/img/wn/{{ w.icon }}@2x.png"
                            alt="icon"
                            width="60"
                        >

                        <h4>{{ w.temp_c }}°C</h4>

                        <p class="mb-1">{{ w.condition }}</p>

                        <small class="text-muted">
                            Humidity: {{ w.humidity }}%
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>


        <!-- PAYMENTS / WALLET -->
        <div class="tab-pane fade" id="payments">
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm p-4 text-center">
                        <h6 class="text-muted mb-2">Available Balance</h6>
                        <h2 class="fw-bold text-success">
                            KES {{ wallet_balance }}
                        </h2>

                        <small class="text-muted">
                            This is money from completed orders not yet paid out.
                        </small>

                        <div class="mt-4">
                            <a href="" class="btn btn-primary btn-lg">
                                Request Payout
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm p-4">
                        <h6 class="mb-3">Wallet Summary</h6>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Sales</span>
                            <strong>KES {{ total_sales_per_farmer }}</strong>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Paid Out</span>
                            <strong class="text-muted">
                                KES {{ total_paid }}
                            </strong>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <span>Available for Payout</span>
                            <strong class="text-success">
                                KES {{ wallet_balance }}
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- MESSAGES -->
        <div class="tab-pane fade" id="messages">
            {% for msg in inquiries %}
            <div class="card p-2 mb-2">
                {{ msg.buyer }}: {{ msg.message }}
            </div>
            {% endfor %}
        </div>

        <!-- REPORTS -->
        <div class="tab-pane fade" id="reports">
            <h5>Analytics</h5>
            <p>Sales trends, charts, and performance KPIs go here.</p>
        </div>

    </div>
</div>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="{% static 'assets/js/farmer_dashboard.js' %}"></script>
</section>
{% endblock %}
