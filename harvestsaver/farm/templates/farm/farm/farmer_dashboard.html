{% extends "accounts/layout.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Farmer Dashboard
{% endblock %}

{% block category %}
<section>
<div class="container mt-4">
    <h4 class="border-bottom mb-3">Farmer Dashboard</h4>

    <!-- FLASH MESSAGES -->
    <div class="p-2">
        {% for message in messages %}
        <p class="alert alert-{{message.tags}}">{{message}}</p>
        {% endfor %}
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs" id="farmerTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">Overview</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#farm">My Farm</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#products">Products</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orders">Orders</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#inventory">Inventory</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#weather">Weather</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments">Payments</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#messages">Messages</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports">Reports</button>
        </li>
    </ul>

    <!-- TAB CONTENT -->
    <div class="tab-content mt-4">

        <!-- OVERVIEW -->
        <div class="tab-pane fade show active" id="overview">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Products</h6>
                        <h4>{{ total_products }}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Orders</h6>
                        <h4>{{ total_orders }}</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 shadow-sm">
                        <h6>Total Sales</h6>
                        <h4>KES {{ total_sales }}</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- FARM PROFILE TAB -->
        <div class="tab-pane fade" id="farm">
            <h5>Your Farms</h5>

            {% if farms %}
                <div class="d-flex">
                {% for farm in farms %}
                    <div class="card mb-3 me-1 p-2 {%if not farm.is_verified %}bg-warning{%endif%}">
                        <div class="card-body">
                            <h6>{{ farm.name }}</h6>
                            <p><strong>Owner:</strong> {{ farm.owner.get_full_name }}</p>
                            <p><strong>Latitude:</strong> {{ farm.latitude }}</p>
                            <p><strong>Longitude:</strong> {{ farm.longitude }}</p>
                            <p><strong>Address:</strong> {{ farm.address }}</p>
                            <p><strong>Hub:</strong> {{ farm.hub.name|default:"Not assigned" }}</p>
                            <p><strong>Verified:</strong> {%if farm.is_verified %}Yes{%else%}No{%endif%}</p>
                            <p><strong>Created At:</strong> {{ farm.created_at|date:"M d, Y" }}</p>

                            <button class="btn btn-sm btn-primary" onclick="showForm({{ farm.id }})">Edit</button>

                            <!-- Hidden edit form -->
                            <div id="farm-form-{{ farm.id }}" style="display:none; margin-top: 10px;">
                                <form action="{% url 'farm:farmer_dashboard' %}" method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="farm_id" value="{{ farm.id }}">
                                    {% if edit_form and edit_form.instance.id == farm.id %}
                                        {{ edit_form|crispy }}
                                    {% endif %}
                                    <button type="submit" class="btn btn-success btn-sm">Save</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <p>No farms available.</p>
            {% endif %}

            <h5 class="mt-4">Create New Farm</h5>
            <div class="card p-3 col-md-6">
                <form action="{% url 'farm:create_or_edit_farm' %}" method="post" enctype="multipart/form-data" id="new-farm-form">
                    {% csrf_token %}
                    {{ new_farm_form.name|as_crispy_field }}
                    {{ new_farm_form.address|as_crispy_field }}

                    <!-- Hidden latitude/longitude -->
                    <input type="hidden" name="latitude" id="id_latitude" required>
                    <input type="hidden" name="longitude" id="id_longitude" required>

                    <label class="mt-3 fw-bold">Pick Farm Location</label>
                    <div id="farm-map" style="height: 400px;"></div>

                    <button type="submit" class="btn btn-primary mt-3">Add Farm</button>
                </form>
            </div>
        </div>


        <!-- PRODUCTS -->
        <div class="tab-pane fade" id="products">
            {% for product in current_farmer_products  %}
                <div class="card p-2 mb-2">
                    {{ product.name }} - KES {{ product.price }}
                </div>
            {% empty %}
                <p>No products yet.</p>
            {% endfor %}
            <div class="row">
                <hr>
                <div class="col-md-6">
                    <form action="{% url 'farm:create_product' %}" method="POST" enctype="multipart/form-data">
                        {%csrf_token%}
                        {{products_form|crispy}}
                        <div class="">
                            <button class="btn btn-primary btn-lg" type="submit">
                                Add Product
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ORDERS -->
        <div class="tab-pane fade" id="orders">
            {% for item in order_items %}
                <div class="card p-2 mb-2">
                    <div>
                        <strong>Order #{{ item.order.id }}</strong>
                        ({{ item.order.status }})
                    </div>

                    <div>
                        Buyer: {{ item.order.customer.username }}
                    </div>

                    <div>
                        Product: {{ item.product.name }}
                    </div>

                    <div>
                        Quantity: {{ item.quantity }}
                    </div>

                    <div>
                        Subtotal: 
                        {{ item.quantity|floatformat:2 }} × {{ item.product.price }} =
                        <strong>KES {{ item.subtotal }}</strong>
                    </div>
                </div>
            {% empty %}
                <p>No orders for your products yet.</p>
            {% endfor %}
        </div>


        <!-- INVENTORY -->
        <div class="tab-pane fade" id="inventory">
            {% for item in inventory %}
            <div class="d-flex justify-content-between border p-2 mb-1">
                <span>{{ item.product.name }}</span>
                <span>{{ item.quantity }} units</span>
            </div>
            {% endfor %}
        </div>

        <!-- WEATHER -->
        <div class="tab-pane fade" id="weather">
            <h5 class="mb-3">Next 24 Hours Forecast</h5>

            <div class="row">
                {% for w in weather_data_list %}
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card text-center shadow-sm p-3">

                        <small class="text-muted">
                            {{ w.dt_readable|date:"D, H:i" }}
                        </small>

                        <img 
                            src="https://openweathermap.org/img/wn/{{ w.icon }}@2x.png"
                            alt="icon"
                            width="60"
                        >

                        <h4>{{ w.temp_c }}°C</h4>

                        <p class="mb-1">{{ w.condition }}</p>

                        <small class="text-muted">
                            Humidity: {{ w.humidity }}%
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>


        <!-- PAYMENTS -->
        <div class="tab-pane fade" id="payments">
            <h5>Wallet</h5>
            <p>Available Balance: KES {{ wallet.balance }}</p>
            <a href="#" class="btn btn-outline-primary">Request Payout</a>
        </div>

        <!-- MESSAGES -->
        <div class="tab-pane fade" id="messages">
            {% for msg in inquiries %}
            <div class="card p-2 mb-2">
                {{ msg.buyer }}: {{ msg.message }}
            </div>
            {% endfor %}
        </div>

        <!-- REPORTS -->
        <div class="tab-pane fade" id="reports">
            <h5>Analytics</h5>
            <p>Sales trends, charts, and performance KPIs go here.</p>
        </div>

    </div>
</div>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="{% static 'assets/js/farmer_dashboard.js' %}"></script>
</section>
{% endblock %}
